var UNITS={},TAB_ID=Math.random(),USER_FEATURES=["CAN_RESIZE_CANVAS"],UNIT_ID_COUNTER=0,SELECTED_CLASS="SELECTED",BUFFER={},IS_DRAGGING=!1,IS_RESIZING=!1,MODE="EDIT",START_Z_INDEX="1000",LOW_Z_INDEX=START_Z_INDEX,CURRENT_Z_INDEX=START_Z_INDEX,USER_IS_PREMIUM=!0,USER_IS_LOGGED_IN=!0,FLAG_CHANGED=!1,START_SAVING=!1,AUTOSAVE_TIMEOUT=3E4,UPPER_PANEL_Z_INDEX=9E3,DRAGGING_Z_INDEX=9999,DOCUMENT_WIDTH=1104,WS_WIDTH=800,WS_HEIGHT=1070,WS_TOP=0,WS_LEFT=152,WS_ACCEPT_CLS="TOOL",TC_CLS="toolcover",WS_UNIT_CLS= "UNIT",UNIT_ID_ATTR="UNIT_ID",PH_SELECTOR="#pageheader",TB_SELECTOR="#TOOLBAR",REV_SELECTOR="#REVISIONS",WS_SELECTOR="#WORKSHEET",BG_WRAPPER_SELECTOR="#BACKGROUND_WRAPPER",PR_SELECTOR="#PROPERTIES",UP_SELECTOR="#UNIT_PROPERTIES",FRAME_BACKGROUND_SELECTOR="#SET_FRAME_BACKGROUND",FRAME_REMOVE_BACKGROUND_SELECTOR="#REMOVE_FRAME_BACKGROUND";FRAME_HTML_DOWNLOAD_SELECTOR="#DOWNLOAD_HTML_FRAME";FRAME_HIDE_BACKGROUND_SELECTOR="#HIDE_BACKGROUND";NEW_FRAME_FROM_COPY_SELECTOR="#NEW_FRAME_FROM_COPY"; ENABLE_TEAM_WORK_SELECTOR="#ENABLE_TEAM_WORK";DELETE_BTN_SELECTOR="#DELETE_SELECTED_UNIT";COPY_BTN_SELECTOR="#COPY_SELECTED_UNIT";PASTE_BTN_SELECTOR="#PASTE_SELECTED_UNIT";UP_BTN_SELECTOR="#UP_SELECTED_UNIT";DROP_BTN_SELECTOR="#DROP_SELECTED_UNIT";SAVE_BTN_SELECTOR="#SAVE_FRAME";PRIVATE_BTN_SELECTOR="#makeframeprivate";TOGGLE_BG_BTN_SELECTOR=".js-hide-bg";WORKSPACE_SELECTOR="#WORKSPACE";SELECTING_AREA_CLASS="SELECTING_AREA";LINK_TO_MOCKUP_SELECTOR="#linkToMockup";NOTIFICATIONS_SELECTOR=".notifications"; GRID_CELL_SIZE=5;PASTE_OFFSET=3*GRID_CELL_SIZE;SELECTED_COLOR="#F6921E";UNSELECTED_COLOR="#EEEEEE";ICON_BASE_URL="/static/images/";COMMING_SOON_CLS="comingsoonfeature";PROCESS_ACTION_CLS="processactionfeature";EAC_ACTIVE=!1;EAC_TOOL="";EAC_POSITION={top:0,left:0};EAC_ARROW_BUTTON="#TOOLBAR .TOOL-UNSELECT";TOOL_BUTTON_CSS={width:36,height:36,cursor:"move"};UNIT_BORDER_WIDTH=1; UNIT_CSS={"border-width":UNIT_BORDER_WIDTH,"border-style":"solid","border-color":UNSELECTED_COLOR,position:"absolute",overflow:"hidden",cursor:"move","margin-top":0,"margin-left":0};PREVIEW_UNIT_CSS={border:"none",overflow:"hidden",cursor:"auto","margin-top":UNIT_BORDER_WIDTH,"margin-left":UNIT_BORDER_WIDTH};PREVIEW_COMMENT_UNIT_CSS={border:"none",background:"#1c94c4",cursor:"auto",opacity:"0.09",filter:"alpha(opacity=5)"}; TOOLS={COMMENT:{html:'<div><div class="COMMENT needresize needcss text box"></div><div class="glass"></div></div>',icon:"box.png",label:"Box",dimension:{width:80,height:30},css:{border:"2px solid #1c94c4",visibility:"hidden"}},BOX:{html:'<div><div class="needresize needcss url box"></div><div class="glass"></div></div>',icon:"box.png",label:"Box",dimension:{width:400,height:200},css:{border:"2px solid #484848"}},TEXT:{html:'<div><pre class="text needcss url">text</pre><div class="glass"></div></div>', icon:"text.png",label:"Text",dimension:{width:110,height:20},css:{"font-size":"14px",padding:"2px","font-family":"Georgia,serif","line-height":"18px"}},HEADER:{html:'<div><h3 class="text needcss url">Text Header</h3><div class="glass"></div></div>',icon:"header.png",label:"Text Header",dimension:{width:210,height:30},css:{"font-size":"22px",padding:"2px","font-family":"Georgia,serif","line-height":"26px","font-weight":"normal"}},TEXTBOX:{html:'<div><pre class="text needcss needresize textbox">text</pre><div class="glass"></div></div>', icon:"textbox.png",label:"Text Box",dimension:{width:110,height:30},css:{overflow:"hidden",height:"100%","font-size":"14px",padding:"2px","font-family":"Georgia,serif","line-height":"18px",border:"2px solid #484848"}},LINK:{html:'<div><a href="#" class="text needcss url">text link</a><div class="glass"></div></div>',icon:"link.png",label:"Text Link",dimension:{width:110,height:20},css:{color:"#1111EF","font-size":"14px",padding:"2px","font-family":"Georgia,serif"}},BUTTON:{html:'<div><input class="needresize text needcss url" type="button" value="BUTTON" /><div class="glass"></div></div>', icon:"button.png",label:"Button",dimension:{width:90,height:35},css:{display:"block","font-family":"Georgia,serif"}},INPUT:{html:'<div><input class="needresize needcss" type="text" value="" /><div class="glass"></div></div>',icon:"input.png",label:"Text Input",dimension:{width:110,height:20},css:{display:"block","background-color":"#F5F0F5"}},TEXTAREA:{html:'<div><textarea class="needresize needcss"></textarea><div class="glass"></div></div>',icon:"textarea.png",label:"Text Area",dimension:{width:250, height:120},css:{display:"block",margin:"0px","background-color":"#F5F0F5"}},RADIO:{html:'<div><input type="radio" /><div class="glass"></div></div>',icon:"radio.png",label:"Radio Input",dimension:{width:30,height:20},css:{}},CHECKBOX:{html:'<div><input type="checkbox" /><div class="glass"></div></div>',icon:"checkbox.png",label:"Checkbox",dimension:{width:30,height:20},css:{}},SELECT:{html:'<div><select class="text"><option>option 1</option><option>option 2</option><option>option 3</option></select><div class="glass"></div></div>', icon:"select.png",label:"Select",dimension:{width:80,height:30},css:{}},HLINE:{html:'<div><div class="needresize needcss hline">&nbsp;</div><div class="glass"></div></div>',icon:"hline.png",label:"Horizontal Line",dimension:{width:400,height:15},css:{"border-top":"2px solid #484848","margin-top":"5px"}},VLINE:{html:'<div><div class="needresize needcss vline">&nbsp;</div><div class="glass"></div></div>',icon:"vline.png",label:"Vertical Line",dimension:{width:15,height:200},css:{"border-left":"2px solid #484848", "margin-left":"5px"}},IMAGE:{html:'<div><div class="image" style="height:100%; text-align: center; position: relative; border:1px solid #3399FF"><img class="needresize needcss text image url" alt="No image. Double click to change image\'s URL." src="'+ICON_BASE_URL+'default_image.png" /></div><div class="glass"></div></div></div>',icon:"image.png",label:"Image",dimension:{width:128,height:84},css:{position:"absolute",top:"0",bottom:"0",left:"0",right:"0",margin:"auto"}}}; TEXT_TOOLBAR_UNITS={TEXT:!0,TEXTBOX:!0,HEADER:!0};STORABLE_CLASSES={"text-bold":!0,"text-italic":!0,"text-underline":!0,"text-left":!0,"text-right":!0,"text-center":!0};DEFAULT_TOOLBAR_POSITIONS={TB:{top:0,left:0,"z-index":9E3},PR:{top:0,left:960,"z-index":8999},REV:{top:450,left:0,"z-index":8998}};CURRENT_ACTION={is_executed:!0}; function Action(){var a=this;this.is_executed=!1;this.forward=function(){void 0!==CURRENT_ACTION&&(CURRENT_ACTION.next_action=a);a.previous_action=CURRENT_ACTION;CURRENT_ACTION=a;a.is_executed=!0};this.backward=function(){CURRENT_ACTION=a.previous_action};this.doAction=function(){a._do();a.forward()};this.undoAction=function(){a._undo();a.backward()}}Array.prototype.contains=function(a){for(var b=0,c=this.length;b<c;b++)if(this[b]==a)return b}; function getUnit(a){return $("["+UNIT_ID_ATTR+"="+a+"]")}function isCommentOwner(a){return IS_OWNER||a.attr("author")==USERNAME}function getUnitsIds(a){ids=[];$.each(a,function(a,c){ids[a]=$(c).attr(UNIT_ID_ATTR)});return ids}var delete_me="delete";function canBeLink(a){return"LINK"==a||"BOX"==a||"TEXT"==a||"HEADER"==a||"BUTTON"==a||"IMAGE"==a}function frameChanged(){FLAG_CHANGED=!0} function startSelecting(a){if(!("EDIT"!==MODE||EAC_ACTIVE&&EAC_TOOL.length)){BUFFER["start selecting"]={top:a.pageY-$(WORKSPACE_SELECTOR).position().top,left:a.pageX-$(WORKSPACE_SELECTOR).position().left-WS_LEFT};var b=!1;$.each($("."+WS_UNIT_CLS).not(".COMMENT"),function(a,d){BUFFER["start selecting"].top>=parseInt($(d).css("top"),10)&&BUFFER["start selecting"].top<=parseInt($(d).css("top"),10)+parseInt($(d).css("height"),10)+2*UNIT_BORDER_WIDTH&&BUFFER["start selecting"].left>=parseInt($(d).css("left"), 10)&&BUFFER["start selecting"].left<=parseInt($(d).css("left"),10)+parseInt($(d).css("width"),10)+2*UNIT_BORDER_WIDTH&&(b=!0)});b?delete BUFFER["start selecting"]:(gaEvent("common","select by mouse"),$.each($("."+WS_UNIT_CLS),function(a,b){unselectUnit(b)}),$(DELETE_BTN_SELECTOR).button("disable"),$(COPY_BTN_SELECTOR).button("disable"),$(DROP_BTN_SELECTOR).button("disable"),$(UP_BTN_SELECTOR).button("disable"),a=$('<div class="'+SELECTING_AREA_CLASS+'"></div>').css({top:BUFFER["start selecting"].top, left:BUFFER["start selecting"].left}),$(WS_SELECTOR).append(a))}} function selectProcess(a){if(BUFFER["start selecting"]){BUFFER["end selecting"]={top:a.pageY-$(WORKSPACE_SELECTOR).position().top,left:a.pageX-$(WORKSPACE_SELECTOR).position().left-WS_LEFT};var b=BUFFER["end selecting"].left-BUFFER["start selecting"].left,c=BUFFER["end selecting"].top-BUFFER["start selecting"].top,d=BUFFER["start selecting"].top,e=BUFFER["start selecting"].left;0>b&&(b=-b,e-=b);0>c&&(c=-c,d-=c);$("."+SELECTING_AREA_CLASS).css({width:b,height:c,top:d,left:e});$.each($("."+WS_UNIT_CLS), function(a,g){var n=e,m=e+b,h=parseInt($(g).css("left"),10),l=h+parseInt($(g).css("width"),10)+2*UNIT_BORDER_WIDTH,p=d,q=d+c,r=parseInt($(g).css("top"),10),s=r+parseInt($(g).css("height"),10)+2*UNIT_BORDER_WIDTH;checkIntersection(h,l,n,m)&&checkIntersection(r,s,p,q)?selectUnit(g,!0):unselectUnit(g)})}}function stopSelecting(a){$("."+SELECTING_AREA_CLASS).remove();delete BUFFER["start selecting"];delete BUFFER["end selecting"]} function checkIntersection(a,b,c,d){return a>=c&&a<=d||b>=c&&b<=d||c>=a&&c<=b&&d>=a&&d<=b}function initSelectingArea(){$(WS_SELECTOR).mousedown(startSelecting).mousemove(selectProcess).mouseup(stopSelecting).mouseleave(stopSelecting)}function blockPage(){$.blockUI({message:'<p class="message">Loading ...</p>',css:{width:200,border:"1px solid #CCCCCC",left:($(window).width()-200)/2,padding:15,backgroundColor:"#F6F6F6","-webkit-border-radius":4,"-moz-border-radius":4,color:"#1C94C4"}})} function unblockPage(){$.unblockUI()}function roundToGrid(a,b){var c=a+(a%GRID_CELL_SIZE>GRID_CELL_SIZE/2?GRID_CELL_SIZE-a%GRID_CELL_SIZE:-a%GRID_CELL_SIZE);0>c&&(c=0);b&&(c-=2*UNIT_CSS["border-width"]);return c}function fixLeft(a,b){var c=$(WS_SELECTOR).width()-b;return a>c?roundToGrid(c,!1):0>a?roundToGrid(0,!1):roundToGrid(a,!1)}function fixTop(a,b){var c=$(WS_SELECTOR).height()-b;return a>c?roundToGrid(c,!1):0>a?roundToGrid(0,!1):roundToGrid(a,!1)} function fixMetrics(a,b,c){$(a).find("input[type=text], textarea").css("border","1px solid #999999");var d=2,e=4;$.browser.msie&&(d=4);$(a).find("input[type=text]").css({width:b-d,height:c-e});$.browser.webkit&&(e=d=6);$.browser.mozilla&&(e=2);$(a).find("textarea").css({width:b-d,height:c-e});$(a).find(".box").css({width:b-5,height:c-5});$(a).find(".textbox").css({width:b-9,height:c-9});$(a).find(".hline").css({width:b-1});$(a).find(".vline").css({height:c-1});$(a).find(".image").css({width:b+2*UNIT_BORDER_WIDTH, height:c+2*UNIT_BORDER_WIDTH})}function unselectUnit(a){a=$(a);a.hasClass(SELECTED_CLASS)&&a.css({"border-color":UNSELECTED_COLOR}).resizable("destroy").removeClass(SELECTED_CLASS)}function resizeProcess(a,b){IS_RESIZING=!0;childResize(a.target)} function dragProcess(a,b){var c=$(WS_SELECTOR+" ."+SELECTED_CLASS);"COMMENT"===MODE&&(c=$(".COMMENT ."+SELECTED_CLASS));var d=!1;$.each(c,function(a,c){if(b.helper.attr(UNIT_ID_ATTR)!=$(c).attr(UNIT_ID_ATTR)&&b.helper.hasClass(SELECTED_CLASS)){var g=parseInt($(c).css("top"),10)-BUFFER["dragging position"].top+b.position.top,n=parseInt($(c).css("left"),10)-BUFFER["dragging position"].left+b.position.left;$(c).css({top:fixTop(g,$(c).height()),left:fixLeft(n,$(c).width())});d=!0}updateAnchor(c)});d&& (CURRENT_ACTION.units_ids=getUnitsIds(c));BUFFER["dragging position"]=b.position;c=CURRENT_ACTION.start_parameters;CURRENT_ACTION.delta_parameters={top:b.position.top-c.top,left:b.position.left-c.left}}function EnableTeamWorkEditing(){jQuery.post("/team_work/",{urlid:FRAME_URLID,team_work_enable:!0});alert("Now you can share link of this frame with your teammate: "+document.URL+" \nDon't forget to invite him to project first");location.reload()} function DisableTeamWorkEditing(){jQuery.post("/team_work/",{urlid:FRAME_URLID,team_work_enable:!1});alert("Team-work editing disabled");location.reload()} function send_team_work_delta(a){if(IS_TEAM_WORK){a.urlid=FRAME_URLID;a.action=CURRENT_ACTION.constructor.name;try{a.units_ids=CURRENT_ACTION.units_ids||getUnitsIds(units),"object"!=typeof a.units_ids&&(a.units_ids=[a.units_ids])}catch(b){}try{a.unit_id=CURRENT_ACTION.unit_id}catch(c){}a.sender_id=TAB_ID;params_in_json=jQuery.toJSON(a);jQuery.post("/team_work/",{json:params_in_json})}} function DragAction(){Action.apply(this);var a=this,b,c,d;this._set_top_left=function(a,d,g){$.each(g,function(g,m){unit=getUnit(m);b=parseInt($(unit).css("top"),10);c=parseInt($(unit).css("left"),10);$(unit).css({top:b-a,left:c-d})})};this._do=function(){d=a.delta_parameters;a._set_top_left(-d.top,-d.left,a.units_ids)};this._undo=function(){d=a.delta_parameters;a._set_top_left(d.top,d.left,a.units_ids)}} function startDragProcess(a,b){var c;c=new DragAction;c.forward();c.delta_parameters={top:0,left:0};c.start_parameters={top:b.position.top,left:b.position.left};units=$(WS_SELECTOR+" ."+SELECTED_CLASS);gaEvent("common","drag unit");BUFFER["dragging position"]=b.position;IS_DRAGGING=!0;c.units_ids=$(this).attr("unit_id")}function stopDragProcess(a,b){var c={};c.delta_parameters=CURRENT_ACTION.delta_parameters;send_team_work_delta(c)} function childResize(a,b,c){b=b||$(a).width();c=c||$(a).height();$(a).find(".needresize").css({width:b-2*UNIT_BORDER_WIDTH,height:c-2*UNIT_BORDER_WIDTH});$(a).find(".glass").css({width:b,height:c});fixMetrics(a,b,c);updateAnchor(a)} function ResizeAction(){var a;Action.apply(this);var b=this;this._set_size=function(c){a=getUnit(b.unit_id);$(a).css({width:c.width,height:c.height});$(a).children(".needresize").css({width:c.width-2*UNIT_BORDER_WIDTH,height:c.height-2*UNIT_BORDER_WIDTH});$(a).children(".glass").css({width:c.width,height:c.height})};this._do=function(){b._set_size(b.new_parameters)};this._undo=function(){b._set_size(b.old_parameters)}} function startResize(a,b){var c;c=new ResizeAction;c.forward();gaEvent("common","resize unit");BUFFER["start resizing"]=!0;c.old_parameters={width:$(a.target).width(),height:$(a.target).height(),event:a,ui:b};c.unit_id=$(a.target).attr(UNIT_ID_ATTR)} function stopResize(a,b){delete BUFFER["start resizing"];new_width=$(a.target).width();new_height=$(a.target).height();CURRENT_ACTION.new_parameters={width:new_width,height:new_height,event:a,ui:b};new_parameters={width:new_width,height:new_height};send_team_work_delta({new_parameters:new_parameters})} function unselectableText(a){a?($(WS_SELECTOR).addClass("UNSELECTABLETEXT"),$.browser.msie||$(WS_SELECTOR).attr("onselectstart","return false;")):($(WS_SELECTOR).removeClass("UNSELECTABLETEXT"),$.browser.msie||$(WS_SELECTOR).attr("onselectstart","return true;"))} function selectUnit(a,b){if(!("PREVIEW"===MODE||EAC_ACTIVE&&EAC_TOOL.length)&&("COMMENT"!==MODE||$(a).hasClass("COMMENT_UNIT")&&isCommentOwner($(a))))if(b||$.each($(WS_SELECTOR+" ."+SELECTED_CLASS),function(b,c){$(c).attr(UNIT_ID_ATTR)!=$(a).attr(UNIT_ID_ATTR)&&unselectUnit(c)}),$(a).hasClass(SELECTED_CLASS))b&&!BUFFER["start selecting"]&&unselectUnit(a);else{$(a).css({"border-color":SELECTED_COLOR}).resizable({containment:WS_SELECTOR,grid:[GRID_CELL_SIZE,GRID_CELL_SIZE],start:startResize,resize:resizeProcess, stop:stopResize}).addClass(SELECTED_CLASS);var c=$(WS_SELECTOR+" ."+SELECTED_CLASS);$(DELETE_BTN_SELECTOR).button("enable");$(COPY_BTN_SELECTOR).button("enable");1==c.length?($(DROP_BTN_SELECTOR).button("enable"),$(UP_BTN_SELECTOR).button("enable")):($(DROP_BTN_SELECTOR).button("disable"),$(UP_BTN_SELECTOR).button("disable"))}} function initPropertiesToolbar(){var a=getCurrentUnit(),b=$(UP_SELECTOR);if(a.find(".text").length){if("A"==a.find(".text")[0].tagName)USER_IS_LOGGED_IN?-1!=USER_FEATURES.indexOf("CAN_SET_TAG_URL_AND_TEXT")?b.html('<div id="PROPERTIES_EDIT" style="margin-top:2em"><table style="background-color:rgb(255,255,255)"><tr><td><label for="UNIT_TEXT">Text:</label></td></tr><tr><td><input type="text" id="UNIT_TEXT" /></td></tr><tr><td><label for="UNIT_LINK">Link URL:</label></td></tr><tr><td><input type="text" id="UNIT_LINK"></td></tr><tr><td><input type="button" value="Save" class="js-save" /></td></tr></table></div>'): b.html('<div id="PROPERTIES_EDIT" style="margin-top:2em"><table style="background-color:rgb(255,255,255)"><tr><td><label for="UNIT_TEXT">Text:</label></td></tr><tr><td><input type="text" id="UNIT_TEXT" /></td></tr><tr><td><label for="UNIT_LINK">Link URL:</label></td></tr><tr><td><input disabled="disabled" type="text" id="UNIT_LINK"></td></tr><tr><td><input type="button" value="Save" class="js-save" /></td></tr><tr><td style="color:red;font-size:1.3em"><a href="/s/plans/">Subscribe</a> for URL adding!</td></tr></table></div>'): b.html('<div id="PROPERTIES_EDIT" style="margin-top:2em"><table style="background-color:rgb(255,255,255)"><tr><td><label for="UNIT_TEXT">Text:</label></td></tr><tr><td><input type="text" id="UNIT_TEXT" /></td></tr><tr><td><label for="UNIT_LINK">Link URL:</label></td></tr><tr><td><input disabled="disabled" type="text" id="UNIT_LINK"></td></tr><tr><td><input type="button" value="Save" class="js-save" /></td></tr><tr><td style="color:red;font-size:1.3em"><a href="/c/signin/">Sign in</a> for URL adding!</td></tr></table></div>'), $("#UNIT_LINK").val(getUnitLink(a));else{var c="",c=a.find(".url").length?'<tr><td><label for="UNIT_TEXT">Image URL:</label></td></tr><tr><td><input type="text" id="UNIT_TEXT" /></td></tr>':'<tr><td><label for="UNIT_TEXT">Text:</label></td></tr><tr><td><input type="text" id="UNIT_TEXT" /></td></tr>';a.find(".url").length?("PRE"==a.find(".text")[0].tagName?USER_IS_LOGGED_IN?b.html('<div id="PROPERTIES_EDIT" style="margin-top:2em"><table style="background-color:rgb(255,255,255)"><tr><td><label for="UNIT_TEXT">Text:</label></td></tr><tr><td><textarea id="UNIT_TEXT"></textarea></td></tr><tr><td><label for="UNIT_LINK">Link URL:</label></td></tr><tr><td><input type="text" id="UNIT_LINK"></td></tr><tr><td><input type="button" value="Save" class="js-save" /></td></tr></table></div>'): b.html('<div id="PROPERTIES_EDIT" style="margin-top:2em"><table style="background-color:rgb(255,255,255)"><tr><td><label for="UNIT_TEXT">Text:</label></td></tr><tr><td><textarea id="UNIT_TEXT"></textarea></td></tr><tr><td><label for="UNIT_LINK">Link URL:</label></td></tr><tr><td><input disabled="disabled" type="text" id="UNIT_LINK"></td></tr><tr><td><input type="button" value="Save" class="js-save" /></td></tr><tr><td style="color:red;font-size:1.3em"><a href="/c/signin/">Sign in</a> for URL adding!</td></tr></table></div>'): USER_IS_LOGGED_IN?b.html('<div id="PROPERTIES_EDIT" style="margin-top:2em"><table style="background-color:rgb(255,255,255)">'+c+'<tr><td><label for="UNIT_LINK">Link URL:</label></td></tr><tr><td><input type="text" id="UNIT_LINK"></td></tr><tr><td><input type="button" value="Save" class="js-save" /></td></tr></table></div>'):b.html('<div id="PROPERTIES_EDIT" style="margin-top:2em"><table style="background-color:rgb(255,255,255)">'+c+'<tr><td><label for="UNIT_LINK">Link URL:</label></td></tr><tr><td><input disabled="disabled" type="text" id="UNIT_LINK"></td></tr><tr><td><input type="button" value="Save" class="js-save" /></td></tr><tr><td style="color:red;font-size:1.3em"><a href="/c/signin/">Sign in</a> for URL adding!</td></tr></table></div>'), $("#UNIT_LINK").val(getUnitLink(a))):b.html('<textarea id="UNIT_TEXT"></textarea>');-1!=USER_FEATURES.indexOf("CAN_SET_TAG_URL_AND_TEXT")&&UNITS[a.attr(UNIT_ID_ATTR)].type in TEXT_TOOLBAR_UNITS&&($("<div>").attr("id","TEXT_TOOLBAR").textToolbar({unit:a,change:function(b,c){$("#UNIT_TEXT").addClass(c.add.join(" ")).removeClass(c.remove.join(" "));a.addClass(c.add.join(" ")).removeClass(c.remove.join(" "));UNITS[a.attr(UNIT_ID_ATTR)].classes=a.attr("class").split(/\s+/).filter(function(a,b,c){return a in STORABLE_CLASSES}).join(" ")}}).appendTo(b),$("#UNIT_LINK").length?a.width()<$("#UNIT_LINK").width()?$("#TEXT_TOOLBAR").width($("#UNIT_LINK").width()+6):$("#TEXT_TOOLBAR").width(a.width()):$("#TEXT_TOOLBAR").width(a.width()))}$("#UNIT_TEXT").width(Math.max(a.width()-4,100));$("#PROPERTIES_EDIT").css("margin-top",a.height()+"px");$("#UNIT_TEXT").val(getUnitText(a));a.find(".text");var c=parseInt(a.css("top"),10)+$(WORKSPACE_SELECTOR).position().top+2,d=parseInt(a.css("left"),10)+$(WORKSPACE_SELECTOR).position().left+ WS_LEFT;a.hasClass("COMMENT_UNIT")&&(c+=parseInt(a.css("height"),10));b.css({display:"block",top:c,left:d,"z-index":CURRENT_Z_INDEX+1});$("#UNIT_TEXT").focus();BUFFER.EDITED_UNIT=$(a).attr(UNIT_ID_ATTR)}else a.find(".url").length&&(USER_IS_LOGGED_IN?b.html('<div id="PROPERTIES_EDIT" style="margin-top:2em"><table style="background-color:rgb(255,255,255)"><tr><td><label for="UNIT_LINK">Link URL:</label></td></tr><tr><td><input type="text" id="UNIT_LINK"></td></tr><tr><td><input type="button" value="Save" class="js-save" /></td></tr></table></div>'): b.html('<div id="PROPERTIES_EDIT" style="margin-top:2em"><table style="background-color:rgb(255,255,255)"><tr><td><label for="UNIT_LINK">Link URL:</label></td></tr><tr><td><input disabled="disabled" type="text" id="UNIT_LINK"></td></tr><tr><td><input type="button" value="Save" class="js-save" /></td></tr><tr><td style="color:red;font-size:1.3em"><a href="/c/signin/">Sign in</a> for URL adding!</td></tr></table></div>'),$("#UNIT_LINK").val(getUnitLink(a)),b.css({display:"block",top:parseInt(a.css("top"), 10)+$(WORKSPACE_SELECTOR).position().top+a.height()-18,left:parseInt(a.css("left"),10)+$(WORKSPACE_SELECTOR).position().left+WS_LEFT,"z-index":CURRENT_Z_INDEX+1}),$("#UNIT_LINK").focus(),BUFFER.EDITED_UNIT=$(a).attr(UNIT_ID_ATTR));b.find(".js-save").click(function(){changeUnitText();b.css("display","none")})} function ChangeUnitAction(){Action.apply(this);var a=this;this._do=function(){updateUnitText(getUnit(a.unit_id),a.new_text)};this._undo=function(){updateUnitText(getUnit(a.unit_id),a.old_text)}} function changeUnitText(){if("PREVIEW"!==MODE){var a=new ChangeUnitAction;a.forward();gaEvent("common","change unit text");var b=$("."+WS_UNIT_CLS+"["+UNIT_ID_ATTR+"="+BUFFER.EDITED_UNIT+"]"),c=$("#UNIT_TEXT").val();updateUnitText(b,c);b.find(".url").length&&changeUnitLink(b);var d=b.find(".img");d.length&&d.css({"max-width":null,"max-height":null});a.old_text=UNITS[b.attr(UNIT_ID_ATTR)].text;UNITS[b.attr(UNIT_ID_ATTR)].text=c;a.new_text=c;a.unit_id=$(b).attr(UNIT_ID_ATTR);send_team_work_delta({new_text:a.new_text})}} function changeUnitLink(a){var b=$("#UNIT_LINK").val(),c=/^#/g;b.match(/^(f|ht)tps?:\/\//g)||b.match(c)||(b="http://"+b);UNITS[a.attr(UNIT_ID_ATTR)].link&&"#"!=UNITS[a.attr(UNIT_ID_ATTR)].link||"#"==b||(c="add url to link ("+b+")",gaEvent("common",c),$.post("/c/process-customer-action/",{category:"common",action:c,url:window.location.pathname}));updateUnitLink(a,b);CURRENT_ACTION.old_link=UNITS[a.attr(UNIT_ID_ATTR)].link;UNITS[a.attr(UNIT_ID_ATTR)].link=b;CURRENT_ACTION.new_link=b} function updateUnitText(a,b){if(a.find(".text").length)if("INPUT"==a.find(".text")[0].tagName)a.find(".text").val(b);else if("SELECT"==a.find(".text")[0].tagName){var c=b.split("\n");a.find(".text option").remove();$.each(c,function(b,c){a.find(".text").append("<option>"+c+"</option>")})}else"IMG"==a.find(".text")[0].tagName?a.find(".text").attr("src",b):a.find(".text").text(b)} function updateUnitLink(a,b){a=a.find(".url");a.attr("href",b);if(b)if("http://"!=b)a.css("cursor","pointer").on("click",function(){document.location.href=b;return!1});else a.css("cursor","default").unbind("click")} function getUnitText(a){if(a.find(".text").length){if("INPUT"==a.find(".text")[0].tagName)return a.find(".text").val();if("SELECT"==a.find(".text")[0].tagName){var b="",c=a.find("option");$.each(c,function(a,e){var k=$(e).text();b+=k+(a<c.length-1?"\n":"")});return b}return"IMG"==a.find(".text")[0].tagName?a.find(".text").attr("src"):a.find(".text").text()}return""}function getUnitLink(a){if(a.find(".url").length)return a.find(".url").attr("href")} function loadUnitProperties(a){if(a.find(".text").length){var b=UNITS[a.attr(UNIT_ID_ATTR)].text;updateUnitText(a,b)}a.find(".url").length&&(b=UNITS[a.attr(UNIT_ID_ATTR)].link,updateUnitLink(a,b))}function clickUnit(a){gaEvent("common","click unit");$("div[class*="+SELECTED_CLASS+"]").length||selectUnit(this,a.ctrlKey);if(IS_DRAGGING||IS_RESIZING)IS_DRAGGING?IS_DRAGGING=!1:IS_RESIZING=!1;BUFFER["start selecting"]||BUFFER["start resizing"]||selectUnit(this,a.ctrlKey)} function dbclickUnit(a){EAC_ACTIVE&&EAC_TOOL.length||(gaEvent("common","double click unit"),initPropertiesToolbar())} function addCommentMouseOver(a,b){$(a).mouseover(function(){if("PREVIEW"==MODE){$(a).css({opacity:"0.25",filter:"alpha(opacity=2)"});var b=parseInt(a.css("top"),10)+$(WORKSPACE_SELECTOR).position().top,d=parseInt(a.css("left"),10)+$(WORKSPACE_SELECTOR).position().left+WS_LEFT,b=b+parseInt(a.css("height"),10);width=Math.max(200,parseInt(a.css("width"),10));var e='<div style="background:white; width:'+width+'px;font-size:14px;">'+a.text()+'<br> <div style="font-size:10px;">author:'+$(a).attr("author")+ "</div></div>";$(UP_SELECTOR).html(e);$(UP_SELECTOR).css({display:"block",top:b,left:d,"z-index":CURRENT_Z_INDEX+1})}});$(a).mouseout(function(){"PREVIEW"==MODE&&($(a).css({opacity:"0.09",filter:"alpha(opacity=5)"}),$(UP_SELECTOR).css({display:"none"}))})} function createUnit(a,b,c){var d=TOOLS[a],e=roundToGrid(d.dimension.width,!0),k=roundToGrid(d.dimension.height,!0),g=fixLeft(b.left,e);b=fixTop(b.top,k);c||(c=++UNIT_ID_COUNTER);g=$.extend({top:b,left:g},DEFAULT_ANCHOR);b=WS_UNIT_CLS;"COMMENT"==a&&(b+=" COMMENT_UNIT");e=$(d.html).attr("class",b).data("anchor",g).css({width:e,height:k});alignUnit(e);e.css({"z-index":CURRENT_Z_INDEX}).css(UNIT_CSS).draggable({containment:WS_SELECTOR,drag:dragProcess,start:startDragProcess,stop:stopDragProcess,grid:[GRID_CELL_SIZE, GRID_CELL_SIZE]}).attr(UNIT_ID_ATTR,c).mouseup(clickUnit).dblclick(dbclickUnit);e.find(".needcss").css(d.css);CURRENT_UNIT=c;UNITS[c]={type:a,text:getUnitText(e)};"COMMENT"===a&&addCommentMouseOver(e,c);e.hasClass("COMMENT_UNIT")&&e.attr("author",USERNAME);return e}function UpUnitAction(){Action.apply(this);var a=this;this._do=function(){changeZIndex(a.units_ids,1)};this._undo=function(){changeZIndex(a.units_ids,-1)}} function changeZIndex(a,b){$.each(a,function(a,d){unit=getUnit(d);ix=parseInt(CURRENT_Z_INDEX,10);ix+=b;CURRENT_Z_INDEX=ix.toString();$(unit).css("z-index",CURRENT_Z_INDEX)})}function upUnit(){var a=new UpUnitAction;a.forward();var b=$(WS_SELECTOR+" ."+SELECTED_CLASS);a.units_ids=getUnitsIds(b);changeZIndex(a.units_ids,1);send_team_work_delta({})} function dropUnit(){var a=$(WS_SELECTOR+" ."+SELECTED_CLASS);$.each(a,function(a,c){ix=parseInt(LOW_Z_INDEX,10);ix-=1;LOW_Z_INDEX=ix.toString();$(c).css("z-index",LOW_Z_INDEX)})}function DeleteUnitAction(){Action.apply(this);var a=this;this._do=function(){$.each(a.units_ids,function(a,c){unit=getUnit(c);unit.remove();delete UNITS[c]})};this._undo=function(){pasteUnit("deleted",a,!0)}} function deleteSelectedUnit(){action=new DeleteUnitAction;action.forward();var a=$(WS_SELECTOR+" ."+SELECTED_CLASS);addUnitsToBuffer(a,"deleted",action);a.length&&(action.units_ids=[],$.each(a,function(a,c){action.units_ids[a]=$(c).attr(UNIT_ID_ATTR);$(c).hasClass("COMMENT_UNIT")&&$(c).attr("unit_id")}),deleteUnits(a),$(DELETE_BTN_SELECTOR).button("disable"),$(COPY_BTN_SELECTOR).button("disable"),$(DROP_BTN_SELECTOR).button("disable"),$(UP_BTN_SELECTOR).button("disable"));$("#PROPERTIES_EDIT").hide(); send_team_work_delta({})}function deleteUnits(a){a.remove();$.each(a,function(a,c){delete UNITS[$(c).attr(UNIT_ID_ATTR)]})}function addUnitsToBuffer(a,b,c){c=c||BUFFER;c[b]={};$.each(a,function(a,e){var k=$(e).attr(UNIT_ID_ATTR),g=$.extend({},$(e).data("anchor"));c[b][k]={type:UNITS[k].type,text:UNITS[k].text,link:UNITS[k].link,top:parseInt($(e).css("top"),10),left:parseInt($(e).css("left"),10),width:parseInt($(e).width(),10),height:parseInt($(e).height(),10),anchor:g,id:k};updateAnchor(e)})} function copyUnit(){var a=$(WS_SELECTOR+" ."+SELECTED_CLASS);a.length&&(addUnitsToBuffer(a,"copied units"),$(PASTE_BTN_SELECTOR).button("enable"));BUFFER["paste offset X"]=PASTE_OFFSET;BUFFER["paste offset Y"]=PASTE_OFFSET} function pasteOffset(a,b){var c=$(WS_SELECTOR).width(),d=$(WS_SELECTOR).height();if("top"==b)return a.top+a.height+2*UNIT_BORDER_WIDTH+BUFFER["paste offset Y"]>d&&(BUFFER["paste offset Y"]-=PASTE_OFFSET),BUFFER["paste offset Y"];a.left+a.width+2*UNIT_BORDER_WIDTH+BUFFER["paste offset X"]>c&&(BUFFER["paste offset X"]-=PASTE_OFFSET);return BUFFER["paste offset X"]} function PasteUnitAction(){Action.apply(this);var a=this;this._do=function(){pasteUnit("copied units",BUFFER,!1,!0)};this._undo=function(){for(var b=a.new_units.length,c=0;c<b;c++)element=a.new_units[c],element.remove(),delete UNITS[$(element).attr(UNIT_ID_ATTR)]}} function pasteUnit(a,b,c,d){void 0===b&&(action=new PasteUnitAction,action.forward(),send_team_work_delta({buffer:BUFFER}));b=action.buffer||b||BUFFER;a=a||"copied units";if(b[a]&&!b["start resizing"]&&"EDIT"===MODE){$.each($(WS_SELECTOR+" ."+SELECTED_CLASS),function(a,b){unselectUnit(b)});var e=[],k;for(k in b[a]){var g=b[a][k],n=TOOLS[g.type],m=g.id;c||(m=++UNIT_ID_COUNTER);var h=g.top;void 0!==pasteOffset(g,"top")&&(h+=pasteOffset(g,"top"));var l=g.left;void 0!==pasteOffset(g,"left")&&(l+=pasteOffset(g, "left"));d&&(h-=PASTE_OFFSET,l-=PASTE_OFFSET);h=$(n.html).attr("class",WS_UNIT_CLS).data("anchor",g.anchor).css({top:h,left:l,width:g.width,height:g.height}).css(UNIT_CSS).draggable({containment:WS_SELECTOR,drag:dragProcess,start:startDragProcess,stop:stopDragProcess,grid:[GRID_CELL_SIZE,GRID_CELL_SIZE]}).attr(UNIT_ID_ATTR,m).mouseup(clickUnit).dblclick(dbclickUnit);h.find(".needcss").css(n.css);UNITS[m]={type:g.type,text:g.text,link:g.link};loadUnitProperties(h);$(WS_SELECTOR).append(h);childResize(h); selectUnit(h,!0);updateAnchor(h);e.push(h)}CURRENT_ACTION.new_units=e;d||(b["paste offset X"]+=PASTE_OFFSET,b["paste offset Y"]+=PASTE_OFFSET)}}function DropNewUnitAction(){Action.apply(this);var a=this;this._do=function(){var b=createUnit(a.tool_id,a.position,a.new_unit_id);jQuery("#WORKSHEET").append(b);childResize(b);selectUnit(b,!1);a.new_unit=b};this._undo=function(){a.new_unit.remove();delete UNITS[$(a.new_unit).attr(UNIT_ID_ATTR)]}} function dropNewUnit(a,b){action=new DropNewUnitAction;action.forward();action.ui=b;action.event=a;b.helper.remove();ws_offset=$(WS_SELECTOR).offset();position={left:a.pageX-ws_offset.left,top:a.pageY-ws_offset.top};CURRENT_ACTION.draggable=b.draggable;CURRENT_ACTION.position=position;action.tool_id=void 0===CURRENT_ACTION.draggable.attr?CURRENT_ACTION.draggable:CURRENT_ACTION.draggable.attr("id");var c=createUnit(action.tool_id,position);action.new_unit_id=c.attr(UNIT_ID_ATTR);$(this).append(c); action.th=$(this);childResize(c);selectUnit(c,!1);var d=!0,e;for(e in UNITS){d=!1;break}d?gaEvent("common","create unit"):(gaEvent("common","create frame"),$.post("/c/process-customer-action/",{category:"common",action:"create frame"}),(d=$.cookie("anonymous"))&&!$.cookie("active_visit")&&$.get("/n/first_action/"+d+"/"));CURRENT_ACTION.position=position;CURRENT_ACTION.new_unit=c;data_to_send={position:position,tool_id:action.tool_id,new_unit_id:action.new_unit_id};send_team_work_delta(data_to_send)} function getCurrentUnit(){return $(WS_SELECTOR+" ."+SELECTED_CLASS)} function showArrowButton(){var a=$(".arrow-tool-button");if(a.length)a.show();else{var a=$("<div/>").addClass("toolcover arrow-tool-button").appendTo($("#TOOLBAR .sidebarbox")),b=$("<div/>").addClass("toolmargin").appendTo(a);$("<div/>").addClass("TOOL-UNSELECT").css({"background-image":'url("/media/images/arrow.png")',width:"36px",height:"36px",cursor:"pointer"}).click(function(){$("#TOOLBAR .TOOL").removeClass("eac-enabled").css("cursor","pointer");$(this).addClass("eac-enabled").css("cursor","default"); $.each($("."+WS_UNIT_CLS),function(a,b){$(b).draggable("enable").css("cursor","move")});$(WS_SELECTOR).unbind("mousedown");$(WS_SELECTOR).mousedown(startSelecting);$(WS_SELECTOR).unbind("mouseup");$(WS_SELECTOR).mouseup(stopSelecting);$(WS_SELECTOR).unbind("mousemove");$(WS_SELECTOR).mousemove(selectProcess);EAC_TOOL=""}).appendTo(b);$("<p/>").text("Edit mode").appendTo(a);$(window).on("keyup",function(a){27==a.which&&$(EAC_ARROW_BUTTON).trigger("click")})}} function hideArrowButton(){var a=$(".arrow-tool-button");a.length&&a.hide()}function eacCanvasMouseDown(a){2==a.button?$(EAC_ARROW_BUTTON).trigger("click"):(EAC_POSITION={left:a.pageX,top:a.pageY},$("<div/>").addClass("glass eac-size-indicator").appendTo($(this)))} function getPositionAndSize(a){var b=$(WS_SELECTOR).offset(),c={};c.left=EAC_POSITION.left<a.pageX?EAC_POSITION.left-b.left:a.pageX-b.left;c.top=EAC_POSITION.top<a.pageY?EAC_POSITION.top-b.top:a.pageY-b.top;c.width=Math.abs(EAC_POSITION.left-a.pageX);c.height=Math.abs(EAC_POSITION.top-a.pageY);return c} function eacCanvasMouseUp(a){if(2!=a.button){$(".eac-size-indicator").remove();a=getPositionAndSize(a);var b=createUnit(EAC_TOOL,{left:a.left,top:a.top});b.height()<a.height&&b.css("height",a.height);b.width()<a.width&&b.css("width",a.width);b.draggable("disable").css("cursor","default").removeClass("ui-draggable-disabled ui-state-disabled");$(this).append(b);childResize(b);selectUnit(b,!1)}}function eacCanvasMouseMove(a){2!=a.button&&(a=getPositionAndSize(a),$(".eac-size-indicator").css(a))} function enableEAC(){$("#TOOLBAR .TOOL").click(function(){$(this).attr("id")==EAC_TOOL?$(EAC_ARROW_BUTTON).trigger("click"):($("#TOOLBAR .TOOL, #TOOLBAR .TOOL-UNSELECT").removeClass("eac-enabled").css("cursor","pointer"),$(this).addClass("eac-enabled").css("cursor","default"),unselectUnit("."+SELECTED_CLASS),EAC_TOOL=$(this).attr("id"),$(DELETE_BTN_SELECTOR).button("disable"),$(PASTE_BTN_SELECTOR).button("disable"),$(COPY_BTN_SELECTOR).button("disable"),$(DROP_BTN_SELECTOR).button("disable"),$(UP_BTN_SELECTOR).button("disable"), $.each($("."+WS_UNIT_CLS),function(a,b){$(b).draggable("disable").css("cursor","default").removeClass("ui-draggable-disabled ui-state-disabled")}),$(WS_SELECTOR).unbind("mousedown"),$(WS_SELECTOR).mousedown(eacCanvasMouseDown),$(WS_SELECTOR).unbind("mouseup"),$(WS_SELECTOR).mouseup(eacCanvasMouseUp),$(WS_SELECTOR).unbind("mousemove"),$(WS_SELECTOR).mousemove(eacCanvasMouseMove))});$(EAC_ARROW_BUTTON).trigger("click");EAC_ACTIVE=!0} function disableEAC(){$(EAC_ARROW_BUTTON).trigger("click");$("#TOOLBAR .TOOL").unbind("click").removeClass("eac-enabled");EAC_ACTIVE=!1} function initToolModeSwitcher(){var a=$.cookie("tool_mode");null===a&&(a="ontouchstart"in document.documentElement?"eac":"dad",$.cookie("tool_mode","dad"));$(".toolbarswitch select").on("change",function(){$(this).blur();"eac"==$(this).val()?(showArrowButton(),$.cookie("tool_mode","eac"),$("."+WS_ACCEPT_CLS).draggable("disable"),$("#TOOLBAR .TOOL").removeClass("ui-draggable-disabled ui-state-disabled").addClass("eac-tool").css("cursor","pointer"),$(WS_SELECTOR).bind("contextmenu",function(){return!1}), enableEAC()):(hideArrowButton(),$.cookie("tool_mode","dad"),disableEAC(),$("."+WS_ACCEPT_CLS).draggable("enable"),$("."+WS_ACCEPT_CLS+"."+COMMING_SOON_CLS).draggable("disable"),$("#TOOLBAR .TOOL").removeClass("eac-tool").css("cursor","move"),$(WS_SELECTOR).unbind("contextmenu"))});$(".toolbarswitch select").val(a);$(".toolbarswitch select").trigger("change")}function setBackground(){gaEvent("common","set frame background");prepareData();$("#SAVE_FRAME_FORM").submit()} function copyFrame(){gaEvent("common","copy frame");FLAG_CHANGED?alert("Please, save your changes before copying."):($("#SAVE_FRAME_FORM input[name=frame_action]").val("copy"),saveFrame(null,null,!0))} function prepareData(){var a={unit_id_counter:UNIT_ID_COUNTER,units:{},selected_units:[],size:{}};$.each($(WS_SELECTOR+" ."+SELECTED_CLASS),function(b,c){a.selected_units.push($(c).attr(UNIT_ID_ATTR))});a.size={x:WS_WIDTH,y:WS_HEIGHT,left:WS_LEFT};for(var b in UNITS){var c=$("."+WS_UNIT_CLS+"["+UNIT_ID_ATTR+"="+b+"]");a.units[b]={type:UNITS[b].type,text:UNITS[b].text,top:c.css("top"),left:c.css("left"),width:c.width(),height:c.height(),link:UNITS[b].link,position:c.css("position"),z_index:c.css("z-index"), classes:UNITS[b].classes,anchor:c.data("anchor"),author:$("[unit_id="+b+"]").attr("author")}}$("#SAVE_FRAME_FORM input[name=frame_data]").val($.toJSON(a));START_SAVING=!0} function autoSave(){IS_REVISION||IS_COLABORATED||(FLAG_CHANGED?(post_target=FRAME_URLID?"/"+FRAME_URLID:window.location.href,gaEvent("common","auto save frame"),$.post("/c/process-customer-action/",{category:"common",action:"auto save frame",url:window.location.pathname}),prepareData(),$(SAVE_BTN_SELECTOR).find("span").text("Saving..."),$.ajax({type:"POST",url:post_target,dataType:"json",data:$("#SAVE_FRAME_FORM").serializeArray(),success:function(a){$(SAVE_BTN_SELECTOR).find("span").text("Save frame"); FLAG_CHANGED=!1;changeLocation(a);fadeOutMessage()}})):!FLAG_CHANGED||FRAME_DATA||BUFFER["blink save button"]||(BUFFER["blink save button"]=!0,$(SAVE_BTN_SELECTOR).blink()),null!==REVISIONS_FULL_LIST_URL&&$.ajax({url:REVISIONS_FULL_LIST_URL,success:function(a){$("#REVISIONS").html(a)}}),setTimeout(autoSave,AUTOSAVE_TIMEOUT))} function changeLocation(a){FRAME_URLID||(FRAME_URLID=a.frame_urlid,history.replaceState({},document.title,a.url),a=$(LINK_TO_MOCKUP_SELECTOR),a.is(":hidden")&&(a.show(),a.children("input").attr("value",window.location.href)))}function fadeOutMessage(a){$("#fade-out-message").fadeIn("slow",function(){$("#fade-out-message").fadeOut("slow")})} function saveFrame(a,b,c){if(!IS_REVISION||c||confirm("Warning! Saving this revision will delete all other revisions. You can copy frame instead. Save anyway?"))gaEvent("common","save frame"),3650<$("#id_days_to_live").val()&&$("#id_days_to_live").val(3650),c||$("#id_days_to_live").data("fixed")||!$("#id_expire").attr("checked")||($("#id_expire").removeAttr("checked").removeClass("defaulted"),$("#id_days_to_live").val("\u221e"),$("#expire_container").addClass("highlight"),setTimeout(function(){$("#expire_container").removeClass("highlight")}, 300),updateDaysToLive()),prepareData(),post_target=FRAME_URLID?"/"+FRAME_URLID:window.location.href,IS_REVISION&&(post_target=window.location.href),$.ajax({type:"POST",url:post_target,dataType:"json",data:$("#SAVE_FRAME_FORM").serializeArray(),success:function(a){$.post("/c/process-customer-action/",{category:"common",action:"save frame",url:a.url},function(){$("#EDIT_MODE").hasClass("MODE_ON")&&$.cookie("current_mode","edit");changeLocation(a);fadeOutMessage();window.location.href=a.url})}})} function makePrivate(){$("#SAVE_FRAME_FORM input[name=frame_action]").val("make frame private");prepareData();post_target=FRAME_URLID?"/"+FRAME_URLID:window.location.href;$.ajax({type:"POST",url:post_target,dataType:"json",data:$("#SAVE_FRAME_FORM").serializeArray(),success:function(a){$.post("/c/process-customer-action/",{category:"common",action:"make frame private",url:a.url},function(){});a.frame_private?($(PRIVATE_BTN_SELECTOR).removeClass("private-btn-blue"),$(PRIVATE_BTN_SELECTOR).addClass("private-btn-red"), $(PRIVATE_BTN_SELECTOR).attr("title","Make frame public")):($(PRIVATE_BTN_SELECTOR).removeClass("private-btn-red"),$(PRIVATE_BTN_SELECTOR).addClass("private-btn-blue"),$(PRIVATE_BTN_SELECTOR).attr("title","Make frame private"))}})} function loadFrame(a){a=$.evalJSON(a);a.size&&(WS_LEFT=a.size.left,WS_WIDTH=a.size.x,WS_HEIGHT=a.size.y,$(WS_SELECTOR).css({width:WS_WIDTH,height:WS_HEIGHT,left:WS_LEFT}),-1!=USER_FEATURES.indexOf("CAN_RESIZE_CANVAS")&&$(WS_SELECTOR).resizable({handles:"e, s, se"}));$("#width_input").val(WS_WIDTH);$("#height_input").val(WS_HEIGHT);for(var b in a.units){var c=a.units[b],d=TOOLS[c.type];c.anchor||(c.anchor=$.extend({},DEFAULT_ANCHOR));var e=$(d.html).attr("class",WS_UNIT_CLS).css({top:c.top,left:c.left, width:c.width,height:c.height}).data("anchor",c.anchor).css(UNIT_CSS).draggable({containment:WS_SELECTOR,drag:dragProcess,start:startDragProcess,stop:stopDragProcess,grid:[GRID_CELL_SIZE,GRID_CELL_SIZE]}).attr(UNIT_ID_ATTR,b).mouseup(clickUnit).dblclick(dbclickUnit);"COMMENT"==c.type&&(void 0!==c.author&&e.attr("author",c.author),e.addClass("COMMENT_UNIT"),e.css("display","none"),addCommentMouseOver(e,b));c.position?e.css("position",c.position):e.css("position","absolute");c.z_index?e.css("z-index", c.z_index):e.css("z-index",START_Z_INDEX);c.z_index&&"auto"!=c.z_index&&(parseInt(c.z_index,10)>parseInt(CURRENT_Z_INDEX,10)?CURRENT_Z_INDEX=c.z_index:parseInt(c.z_index,10)<parseInt(LOW_Z_INDEX,10)&&(LOW_Z_INDEX=c.z_index));canBeLink(c.type)&&e.attr("href",c.link);c.classes&&e.addClass(c.classes);e.find(".needcss").css(d.css);UNITS[b]={type:c.type,text:c.text,link:c.link,classes:c.classes};loadUnitProperties(e);$(WS_SELECTOR).append(e);childResize(e)}UNIT_ID_COUNTER=a.unit_id_counter;$.each(a.selected_units, function(a,b){var c=$("."+WS_UNIT_CLS+"["+UNIT_ID_ATTR+"="+b+"]");selectUnit(c,!0)})} function resizeCanvas(){maxHeight=-1!=USER_FEATURES.indexOf("CAN_RESIZE_CANVAS")?9E4:2E3;WS_WIDTH=3E3<parseInt($("#width_input").val(),10)?3E3:parseInt($("#width_input").val(),10);WS_HEIGHT=parseInt($("#height_input").val(),10)>maxHeight?maxHeight:parseInt($("#height_input").val(),10);$("#width_input").val(WS_WIDTH);$("#height_input").val(WS_HEIGHT);WS_LEFT=(1080-WS_WIDTH)/2;$(WS_SELECTOR).css({width:WS_WIDTH,height:WS_HEIGHT,left:WS_LEFT}).resizable({handles:"e, s, se"})} function undoAction(){void 0!==CURRENT_ACTION.undoAction&&(gaEvent("common","undo action"),CURRENT_ACTION.undoAction(),gaEvent("common","undo"),$.post("/c/process-customer-action/",{category:"common",action:"undo",url:window.location.pathname}))}function doAction(){void 0!==CURRENT_ACTION.next_action&&(gaEvent("common","do action"),CURRENT_ACTION.next_action.doAction(),gaEvent("common","redo"),$.post("/c/process-customer-action/",{category:"common",action:"redo",url:window.location.pathname}))} function initWorkSpace(){blockPage();initTools();$(DELETE_BTN_SELECTOR).button().click(function(a){gaEvent("common","delete unit");deleteSelectedUnit()}).button("disable");$(document).bind("keydown","del",function(a){gaEvent("common","delete unit hotkey");deleteSelectedUnit()});$(COPY_BTN_SELECTOR).button().click(function(a){gaEvent("common","copy unit");copyUnit()}).button("disable");$(document).bind("keydown","ctrl+c",function(a){gaEvent("common","copy unit hotkey");copyUnit()});$(PASTE_BTN_SELECTOR).button().click(function(){gaEvent("common", "paste unit");pasteUnit()}).button("disable");$(document).bind("keydown","ctrl+v",function(a){gaEvent("common","paste unit hotkey");pasteUnit()});$(document).bind("keydown","ctrl+z",function(a){undoAction()});$(document).bind("keydown","ctrl+y",function(a){doAction()});$(UP_BTN_SELECTOR).button().click(function(a){gaEvent("common","bring unit to front");upUnit()}).button("disable");$(DROP_BTN_SELECTOR).button().click(function(a){gaEvent("common","drop unit");dropUnit()}).button("disable");$("#width_input").val(WS_WIDTH); $("#height_input").val(WS_HEIGHT);$(SAVE_BTN_SELECTOR).button().click(saveFrame);$("#SAVE_COMMENTS_BUTTON").click(saveFrame);$(PRIVATE_BTN_SELECTOR).click(makePrivate);$(FRAME_BACKGROUND_SELECTOR).button();$(FRAME_REMOVE_BACKGROUND_SELECTOR).button();$(FRAME_HTML_DOWNLOAD_SELECTOR).button();$(FRAME_HIDE_BACKGROUND_SELECTOR).button();$(NEW_FRAME_FROM_COPY_SELECTOR).button();$(ENABLE_TEAM_WORK_SELECTOR).button();$(INVITE_USER_BTN_SELECTOR).button();$("#SAVE_FRAME_FORM input[name=background_image]").change(setBackground); $("#SAVE_FRAME_FORM input[type=text], #SAVE_FRAME_FORM textarea").keydown(frameChanged);$("#SAVE_FRAME_FORM input[type=checkbox]").click(frameChanged);$("#SAVE_FRAME_FORM select").change(frameChanged);$(FRAME_REMOVE_BACKGROUND_SELECTOR).click(function(){prepareData();$("#SAVE_FRAME_FORM").submit()});$(TOGGLE_BG_BTN_SELECTOR).click(function(){$(BG_WRAPPER_SELECTOR).toggleClass("transparent");$(TOGGLE_BG_BTN_SELECTOR).toggleClass("activated")});$("body").mousedown(function(a){$UP_SELECTOR=$(UP_SELECTOR); $(a.target).is($UP_SELECTOR)||0<$(a.target).closest(UP_SELECTOR).length||!$UP_SELECTOR.is(":visible")||(changeUnitText(),$UP_SELECTOR.css("display","none"))});$(WS_SELECTOR).droppable({accept:"#COMMENT",drop:dropNewUnit,tolerance:"pointer"});$(WS_SELECTOR).droppable({accept:"."+WS_ACCEPT_CLS,drop:dropNewUnit,tolerance:"pointer"});$(TB_SELECTOR+" ."+WS_ACCEPT_CLS).draggable({helper:"clone",revert:!0,zIndex:DRAGGING_Z_INDEX,cursorAt:{left:-5,top:-5},cursor:"crosshair"});$(REV_SELECTOR+" ."+WS_ACCEPT_CLS).draggable({helper:"clone", revert:!0,zIndex:DRAGGING_Z_INDEX,cursorAt:{left:-5,top:-5},cursor:"crosshair"});$("#COMMENT").draggable({helper:"clone",revert:!0,zIndex:DRAGGING_Z_INDEX,cursorAt:{left:-5,top:-5},cursor:"crosshair"});unselectableText(!0);initSelectingArea();$("#EDIT_MODE").addClass("MODE_ON");""!==FRAME_DATA?loadFrame(FRAME_DATA):redirect_if_hash();"edit"==$.cookie("current_mode")&&$.cookie("current_mode",null);IS_OWNER||IS_COLABORATED||(previewModeOn(),$(".mode-select").val("PREVIEW MODE"),$("<div/>").text("New frame").appendTo($(".headerbuttons")).on("click", function(){window.location="/"}),$(".mode-select").prop("disabled",!0));!IS_OWNER&&IS_COLABORATED&&IS_READONLY&&(previewModeOn(),$(".mode-select").val("PREVIEW MODE"),$(".mode-select > option:first").prop("disabled","disabled"));$.each($(WS_SELECTOR).find("img"),function(a,b){var c=$(b);c.attr("src")==ICON_BASE_URL+"default_image.png"&&c.css({"max-height":84,"max-width":128})});unblockPage();$.cookie("background_image_error")&&(alert($.cookie("background_image_error").replace(/^"|"$/g,"")),$.cookie("background_image_error", null));setTimeout(autoSave,AUTOSAVE_TIMEOUT);initToolModeSwitcher();resizeCanvas();initGrid()}function initTools(){var a=$(TB_SELECTOR+" .sidebarbox"),b;for(b in TOOLS){var c=$('<div class="'+TC_CLS+'"><div class="toolmargin"></div>'),d=$('<div class="'+WS_ACCEPT_CLS+'" id="'+b+'"></div>').css("background-image","url("+ICON_BASE_URL+TOOLS[b].icon+")").css(TOOL_BUTTON_CSS);c.find(".toolmargin").append(d);c.append("<p>"+TOOLS[b].label+"</p>");"COMMENT"!=b&&a.append(c)}} function initGrid(){$(WS_SELECTOR).css({"background-image":"url("+ICON_BASE_URL+"cell10x10.gif)","background-repeat":"repeat"});FRAME_BACKGROUND&&$(BG_WRAPPER_SELECTOR).css({"background-image":"url("+FRAME_BACKGROUND+")","background-repeat":"no-repeat",width:$(WS_SELECTOR).width(),height:$(WS_SELECTOR).height()})} function initResizing(){maxHeight=-1!=USER_FEATURES.indexOf("CAN_RESIZE_CANVAS")?9E4:2E3;$(WS_SELECTOR).resizable({maxWidth:3E3,maxHeight:maxHeight,resize:function(a,b){$("#width_input").val(b.size.width);$("#height_input").val(b.size.height)},stop:function(a,b){initGrid();WS_WIDTH=b.size.width;WS_HEIGHT=b.size.height;$("#width_input").val(WS_WIDTH);$("#height_input").val(WS_HEIGHT);WS_LEFT=(1080-WS_WIDTH)/2;WS_TOP=$(WS_SELECTOR).css("top");$(WS_SELECTOR).css("left",WS_LEFT)}});$(TB_SELECTOR).draggable({stop:saveToolboxPositions}); $(TB_SELECTOR).mousedown(function(){bringPanelToFront(TB_SELECTOR)});$(REV_SELECTOR).draggable({stop:saveToolboxPositions});$(REV_SELECTOR).mousedown(function(){bringPanelToFront(REV_SELECTOR)});$(PR_SELECTOR).draggable({stop:saveToolboxPositions});$(PR_SELECTOR).mousedown(function(){bringPanelToFront(PR_SELECTOR)});restoreToolboxPositions()} function bringPanelToFront(a){a==TB_SELECTOR?($(PR_SELECTOR).css("z-index",UPPER_PANEL_Z_INDEX-1),$(REV_SELECTOR).css("z-index",UPPER_PANEL_Z_INDEX-1),$(TB_SELECTOR).css("z-index",UPPER_PANEL_Z_INDEX)):a==PR_SELECTOR?($(TB_SELECTOR).css("z-index",UPPER_PANEL_Z_INDEX-1),$(REV_SELECTOR).css("z-index",UPPER_PANEL_Z_INDEX-1),$(PR_SELECTOR).css("z-index",UPPER_PANEL_Z_INDEX)):a==REV_SELECTOR&&($(PR_SELECTOR).css("z-index",UPPER_PANEL_Z_INDEX-1),$(TB_SELECTOR).css("z-index",UPPER_PANEL_Z_INDEX-1),$(REV_SELECTOR).css("z-index", UPPER_PANEL_Z_INDEX))}function saveToolboxPositions(){var a=$(TB_SELECTOR),b=$(PR_SELECTOR),c=$(REV_SELECTOR);$.jStorage.set("toolboxes",{TB:{top:a.position().top,left:a.position().left,"z-index":a.css("z-index")},PR:{top:b.position().top,left:b.position().left,"z-index":b.css("z-index")}});c.position()&&$.jStorage.set("toolboxes",{REV:{top:c.position().top,left:c.position().left,"z-index":c.css("z-index")}})} function restoreToolboxPositions(){function a(a,b){if(!b)return!0;var c=$(window).width(),d=$(window).height(),e=a.parent().offset(),l=b.left+e.left,e=b.top+e.top,p=a.width(),q=a.height();return 0>l||0>e||l+p>c||e+q>d}var b=$(TB_SELECTOR),c=$(PR_SELECTOR),d=$(REV_SELECTOR),e=$.jStorage.get("toolboxes",DEFAULT_TOOLBAR_POSITIONS);if(a(b,e.TB)||a(c,e.PR)||a(c,e.REV))e=DEFAULT_TOOLBAR_POSITIONS;b.css(e.TB);c.css(e.PR);d.css(e.REV)} function resetToolboxPositions(){$.jStorage.deleteKey("toolboxes");restoreToolboxPositions()}FLAG_CHANGED_FUNCTIONS="resizeProcess startDragProcess changeUnitText createUnit deleteSelectedUnit copyUnit pasteUnit".split(" ");function _jsCommonDecorator(a,b){return function(){try{return 0<=$.inArray(b,FLAG_CHANGED_FUNCTIONS)&&(FLAG_CHANGED=!0),a.apply(this,arguments)}catch(c){throw c;}}}ALL_FUNCTIONS="startSelecting selectProcess stopSelecting checkIntersection initSelectingArea blockPage unblockPage roundToGrid fixLeft fixTop fixMetrics unselectUnit resizeProcess dragProcess startDragProcess childResize unselectableText selectUnit initPropertiesToolbar changeUnitText getUnitText loadUnitProperties clickUnit createUnit deleteSelectedUnit copyUnit pasteOffset pasteUnit dropNewUnit getCurrentUnit previewModeOn editModeOn commentModeOn saveFrame loadFrame initWorkSpace initTools initGrid prepareData autoSave updateUnitText initPremiumTools initResizing fullscreenModeOn showArrowButton hideArrowButton initToolModeSwitcher eacCanvasMouseDown eacCanvasMouseUp".split(" "); for(var i=0;i<ALL_FUNCTIONS.length;i++){var f=ALL_FUNCTIONS[i];eval(f+"=_jsCommonDecorator("+f+", '"+f+"');")} function initWebsocket(){var a=new WebSocket(WS_URL+"?subscribe-broadcast&publish-broadcast");a.onopen=function(){};a.onmessage=function(a){try{var c=jQuery.evalJSON(a.data);console.log(c);if(c.sender_id!=TAB_ID&&c.urlid==FRAME_URLID){var d=new window[c.action];jQuery.extend(d,c);d.forward();try{d._do()}catch(e){console.log(e)}}}catch(k){}};a.onerror=function(a){};a.onclose=function(a){}} $(function(){initUserStatus(initResizing);initWorkSpace();$(window).bind("beforeunload",function(a){if(FLAG_CHANGED&&!START_SAVING)return"There are unsaved changes on your frame. Are you sure you want to lose them?"});IS_TEAM_WORK&&initWebsocket()});